{# templates/relatorios.html - REFATORADO COM CLASSES TAILWIND CSS #}
{% extends "base.html" %} {# Assume que base.html está usando Tailwind #}

{% block title %}Relatórios - Fast BI{% endblock %}
{% block page_title %}Relatórios{% endblock %} {# Título exibido no header de base.html #}

{% block content %}

{# Formulário de Filtros - Usando Flexbox responsivo e estilo Tailwind #}
<form method="GET" action="{{ url_for('relatorios') }}"
      class="mb-6 flex flex-wrap items-center gap-4 md:gap-6 p-4 bg-white rounded-lg shadow border border-gray-200"> {# Layout, padding, fundo, borda, sombra, margem #}

    {# Grupo Tipo de Relatório #}
    <div class="flex items-center gap-2"> {# Alinha label e select #}
        <label for="report_type" class="text-sm font-medium text-gray-600 whitespace-nowrap">Tipo Relatório:</label>
        {# Select com estilo Tailwind: rounded, border, shadow, focus, padding #}
        <select name="report_type" id="report_type" onchange="this.form.submit()"
                class="rounded-md border-gray-300 shadow-sm focus:border-igreen focus:ring focus:ring-igreen-light focus:ring-opacity-50 text-sm py-2 pl-3 pr-8">
            <option value="base_clientes" {% if selected_report_type == 'base_clientes' %}selected{% endif %}>Base Clientes</option>
            <option value="rateio" {% if selected_report_type == 'rateio' %}selected{% endif %}>Rateio (Geral)</option>
            <option value="rateio_rzk" {% if selected_report_type == 'rateio_rzk' %}selected{% endif %}>Rateio RZK (Especial)</option>
            <option value="clientes_por_licenciado" {% if selected_report_type == 'clientes_por_licenciado' %}selected{% endif %}>Clientes por Licenciado</option>
            <option value="boletos_por_cliente" {% if selected_report_type == 'boletos_por_cliente' %}selected{% endif %}>Boletos por Cliente</option>
        </select>
    </div>

    {# Grupo Fornecedora #}
    <div class="flex items-center gap-2">
        <label for="fornecedora" class="text-sm font-medium text-gray-600 whitespace-nowrap">Fornecedora:</label>
        {# Estilo Select similar ao anterior, adiciona classe para JS desabilitar visualmente #}
        <select name="fornecedora" id="fornecedora"
                class="rounded-md border-gray-300 shadow-sm focus:border-igreen focus:ring focus:ring-igreen-light focus:ring-opacity-50 text-sm py-2 pl-3 pr-8 disabled:opacity-50 disabled:bg-gray-100 disabled:cursor-not-allowed"
                {% if selected_report_type == 'rateio_rzk' or selected_report_type == 'clientes_por_licenciado' %}disabled{% endif %}>
            {% for forn in fornecedoras %}
            <option value="{{ forn }}" {% if forn == selected_fornecedora %}selected{% endif %}>{{ forn }}</option>
            {% endfor %}
            {% if not fornecedoras %}
            <option value="" disabled>Nenhuma disponível</option>
            {% endif %}
        </select>
        {# Mensagens informativas - Estilizadas e controladas por JS #}
        <small data-info-type="rateio_rzk" class="text-xs text-gray-500 italic" style="display: none;">(Fornecedora RZK implícita)</small>
        <small data-info-type="clientes_por_licenciado" class="text-xs text-gray-500 italic" style="display: none;">(Filtro não aplicável)</small>
        {# Campo oculto necessário quando Fornecedora está desabilitado #}
        {% if selected_report_type == 'rateio_rzk' %}
            <input type="hidden" name="fornecedora" value="RZK">
        {% endif %}
    </div>

    {# Botão Buscar - Estilo Tailwind primário #}
    <button type="submit"
            class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
            Buscar
    </button>

    {# Link Exportar Excel - Estilo Tailwind sucesso (verde) #}
    {% if dados %}
    <a href="{{ url_for('exportar_excel_route', fornecedora=selected_fornecedora, report_type=selected_report_type) }}"
       target="_blank"
       class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-igreen hover:bg-igreen-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-igreen transition duration-150 ease-in-out inline-flex items-center">
        <i class="fas fa-file-excel mr-2"></i> {# Ícone opcional #}
        Exportar Excel
    </a>
    {% endif %}
</form>

{# Caixa de Pesquisa - Estilo similar aos filtros #}
<div class="mb-4 flex items-center gap-2 p-4 bg-white rounded-lg shadow border border-gray-200">
     <label for="tableSearch" class="text-sm font-medium text-gray-600 whitespace-nowrap">Pesquisar na tabela:</label>
     {# Input com largura flexível #}
     <input type="text" id="tableSearch" placeholder="Digite para filtrar resultados exibidos..."
            class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-igreen focus:ring focus:ring-igreen-light focus:ring-opacity-50 text-sm py-2 px-3">
</div>

{# --- Tabela de Dados --- #}
{% if error %}
  {# Alerta de Erro Tailwind #}
  <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-md shadow-sm mb-4" role="alert">
    <p class="text-sm font-medium text-red-800">Erro ao carregar dados: {{ error }}</p>
  </div>
{% elif dados %}
  {# Informações da Tabela #}
  <div class="text-sm text-gray-600 mb-2">
    Exibindo {{ dados|length }} de {{ total_items }} registro(s). Página {{ page }} de {{ total_pages }}.
  </div>

  {# Container da Tabela Responsiva #}
  <div class="overflow-x-auto bg-white rounded-lg shadow border border-gray-200 mb-6">
    <table id="dataTable" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50"> {# Cabeçalho com fundo cinza claro #}
            <tr>
                {% for header in headers %}
                {# Células do Cabeçalho: Padding, Alinhamento, Estilo Texto #}
                <th scope="col" class="px-4 py-2.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    {{ header }}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200"> {# Corpo com fundo branco e divisores #}
            {% for row in dados %}
            <tr class="hover:bg-gray-50"> {# Efeito hover na linha #}
                {% for cell in row %}
                {# Células de Dados: Padding, Tamanho Texto, Quebra de linha controlada #}
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                    {{ cell }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
  </div>

  {# --- Paginação Estilizada com Tailwind --- #}
  {% if total_pages > 1 %}
  <nav class="flex justify-center mt-6" aria-label="Pagination">
    <ul class="inline-flex items-center -space-x-px shadow-sm rounded-md">

        {# Botão Anterior #}
        <li>
            {% if page > 1 %}
            <a href="{{ url_for('relatorios', page=page-1, fornecedora=selected_fornecedora, report_type=selected_report_type) }}"
               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 transition duration-150 ease-in-out">
                <span class="sr-only">Anterior</span>
                <i class="fas fa-chevron-left h-5 w-5"></i>
            </a>
            {% else %}
            <span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                <span class="sr-only">Anterior</span>
                <i class="fas fa-chevron-left h-5 w-5"></i>
            </span>
            {% endif %}
        </li>

        {# Números das Páginas #}
        {% set start_page = [1, page-2]|max %}
        {% set end_page = [total_pages, page+2]|min %}

        {# Link para Primeira Página e "..." inicial #}
        {% if start_page > 1 %}
          <li>
            <a href="{{ url_for('relatorios', page=1, fornecedora=selected_fornecedora, report_type=selected_report_type) }}"
               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out">1</a>
          </li>
          {% if start_page > 2 %}
          <li>
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
          </li>
          {% endif %}
        {% endif %}

        {# Loop dos Números Visíveis #}
        {% for p in range(start_page, end_page + 1) %}
          <li>
            {% if p == page %}
             {# Página Ativa #}
            <span aria-current="page" class="relative z-10 inline-flex items-center px-4 py-2 border border-igreen bg-igreen-light text-sm font-semibold text-igreen-dark">
              {{ p }}
            </span>
            {% else %}
             {# Outras Páginas #}
            <a href="{{ url_for('relatorios', page=p, fornecedora=selected_fornecedora, report_type=selected_report_type) }}"
               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out">
               {{ p }}
            </a>
            {% endif %}
          </li>
        {% endfor %}

         {# "..." final e Link para Última Página #}
         {% if end_page < total_pages %}
           {% if end_page < total_pages - 1 %}
           <li>
             <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
           </li>
           {% endif %}
           <li>
             <a href="{{ url_for('relatorios', page=total_pages, fornecedora=selected_fornecedora, report_type=selected_report_type) }}"
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition duration-150 ease-in-out">{{ total_pages }}</a>
           </li>
         {% endif %}

        {# Botão Próximo #}
        <li>
            {% if page < total_pages %}
            <a href="{{ url_for('relatorios', page=page+1, fornecedora=selected_fornecedora, report_type=selected_report_type) }}"
               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 transition duration-150 ease-in-out">
                <span class="sr-only">Próximo</span>
                <i class="fas fa-chevron-right h-5 w-5"></i>
            </a>
            {% else %}
            <span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                <span class="sr-only">Próximo</span>
                <i class="fas fa-chevron-right h-5 w-5"></i>
            </span>
            {% endif %}
        </li>

    </ul>
  </nav>
  {% endif %}
  {# --- Fim da Paginação --- #}

{% elif not error %}
  {# Mensagem se não houver dados #}
  <p class="text-center text-gray-500 italic mt-6">Nenhum dado encontrado para os filtros selecionados.</p>
{% endif %}

{% endblock %}

{# Bloco para scripts JS extras (Manter como estava, pois usa IDs) #}
{% block scripts_extra %}
    {# Script JS principal (contém filtro da tabela) #}
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    {# Script para desabilitar/habilitar o dropdown de Fornecedora #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const reportTypeSelect = document.getElementById('report_type');
            const fornecedoraSelect = document.getElementById('fornecedora');
            const infoMessages = document.querySelectorAll('.filter-form small[data-info-type]');

            function toggleFornecedora() {
                const selectedType = reportTypeSelect.value;
                let disableFornecedora = false;
                let activeInfoType = null;
                const disableTypes = ['rateio_rzk', 'clientes_por_licenciado'];

                if (disableTypes.includes(selectedType)) {
                    disableFornecedora = true;
                    activeInfoType = selectedType;
                }

                fornecedoraSelect.disabled = disableFornecedora;

                infoMessages.forEach(msg => {
                    const msgType = msg.getAttribute('data-info-type');
                    // Usa classes Tailwind para mostrar/esconder em vez de style.display
                    if (msgType === activeInfoType) {
                         msg.classList.remove('hidden');
                         msg.classList.add('inline'); // Ou 'block' se preferir quebra de linha
                    } else {
                         msg.classList.add('hidden');
                         msg.classList.remove('inline', 'block');
                    }
                });
            }

            if (reportTypeSelect && fornecedoraSelect) {
                // Inicializa o estado correto das mensagens informativas no carregamento
                infoMessages.forEach(msg => msg.classList.add('hidden')); // Esconde todas inicialmente
                toggleFornecedora(); // Aplica o estado correto baseado na seleção inicial
                reportTypeSelect.addEventListener('change', toggleFornecedora);
            } else { /* logs de erro */ }
        });
    </script>
{% endblock %}