{# templates/relatorios.html #}

{% extends "base.html" %}

{% block title %}Relatórios - Fast BI{% endblock %}
{% block page_title %}Relatórios{% endblock %}

{% block content %}

{# Formulário de Filtros - O onchange="this.form.submit()" agora recarrega a página com novos params #}
<form method="GET" action="{{ url_for('reports_bp.relatorios') }}" class="filter-form">
    <div class="form-group">
        <label for="report_type">Tipo Relatório:</label>
        <select name="report_type" id="report_type" onchange="this.form.submit()">
            <option value="base_clientes" {% if selected_report_type == 'base_clientes' %}selected{% endif %}>Base Clientes</option>
            <option value="rateio" {% if selected_report_type == 'rateio' %}selected{% endif %}>Rateio (Geral)</option>
            <option value="rateio_rzk" {% if selected_report_type == 'rateio_rzk' %}selected{% endif %}>Rateio RZK (Especial)</option>
            <option value="clientes_por_licenciado" {% if selected_report_type == 'clientes_por_licenciado' %}selected{% endif %}>Clientes por Licenciado</option>
            <option value="boletos_por_cliente" {% if selected_report_type == 'boletos_por_cliente' %}selected{% endif %}>Boletos por Cliente</option>
            <option value="recebiveis_clientes" {% if selected_report_type == 'recebiveis_clientes' %}selected{% endif %}>Recebíveis Clientes</option>
        </select>
    </div>
    <div class="form-group">
        <label for="fornecedora">Fornecedora:</label>
        <select name="fornecedora" id="fornecedora" {% if selected_report_type in ['rateio_rzk', 'clientes_por_licenciado'] %}disabled{% endif %}>
            {% for forn in fornecedoras %}
            <option value="{{ forn }}" {% if forn == selected_fornecedora %}selected{% endif %}>{{ forn }}</option>
            {% endfor %}
            {% if selected_fornecedora not in fornecedoras and selected_fornecedora == 'Consolidado' %}
                 <option value="Consolidado" selected>Consolidado</option>
            {% endif %}
        </select>
         {% if selected_report_type == 'rateio_rzk' %}
            <small data-info-type="rateio_rzk" style="display: none;">(Fornecedora RZK implícita)</small>
             <input type="hidden" name="fornecedora" value="RZK">
        {% elif selected_report_type == 'clientes_por_licenciado' %}
             <small data-info-type="clientes_por_licenciado" style="display: none;">(Filtro não aplicável)</small>
        {% endif %}
    </div>
    <button type="submit" class="btn btn-primary">Buscar</button>
    
    {# O link de exportação será atualizado pelo JS #}
    <a href="#" id="export-link" class="btn btn-success" target="_blank" style="display: none;">
        <i class="fas fa-file-excel"></i> Exportar Excel
    </a>
</form>

{# Caixa de Pesquisa #}
<div class="search-box">
     <label for="tableSearch">Pesquisar na tabela:</label>
     <input type="text" id="tableSearch" placeholder="Digite para filtrar resultados exibidos...">
</div>

{# Container para informações da tabela, será preenchido pelo JS #}
<div class="table-info" style="min-height: 1.5em;"></div>

{# A tabela será preenchida pelo JS. O thead e tbody estão vazios. #}
<div class="table-responsive">
    <table id="dataTable">
        <thead>
            {# Cabeçalho será gerado pelo JS #}
        </thead>
        <tbody>
            {# Linhas serão geradas pelo JS #}
        </tbody>
    </table>
</div>

{# A paginação será preenchida pelo JS #}
<nav class="pagination"></nav>

{% if error %}
  <div class="alert alert-danger">Erro ao carregar a página: {{ error }}</div>
{% endif %}

{% endblock %}

{% block scripts_extra %}
    {# Script para desabilitar/habilitar o dropdown de Fornecedora (sem alterações) #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const reportTypeSelect = document.getElementById('report_type');
            const fornecedoraSelect = document.getElementById('fornecedora');
            // Seleciona TODAS as mensagens <small> com o atributo data-info-type
            const infoMessages = document.querySelectorAll('.filter-form small[data-info-type]');

            function toggleFornecedora() {
                const selectedType = reportTypeSelect.value;
                let disableFornecedora = false;
                let activeInfoType = null; // Guarda qual tipo de info mostrar

                // Define quais tipos de relatório AINDA desabilitam a fornecedora
                const disableTypes = ['rateio_rzk', 'clientes_por_licenciado'];

                if (disableTypes.includes(selectedType)) {
                    disableFornecedora = true;
                    activeInfoType = selectedType; // O tipo ativo é o próprio tipo selecionado
                }

                // Aplica o estado desabilitado/habilitado
                fornecedoraSelect.disabled = disableFornecedora;

                // Mostra/esconde as mensagens informativas
                infoMessages.forEach(msg => {
                    const msgType = msg.getAttribute('data-info-type');
                    // Mostra a mensagem APENAS se o tipo dela for o que está ativo E desabilitando o select
                    if (msgType === activeInfoType) {
                         msg.style.display = 'inline';
                    } else {
                         msg.style.display = 'none'; // Esconde todas as outras
                    }
                });

                 // Se desabilitado, garante que o valor enviado (se houver) seja o correto
                 if (disableFornecedora) {
                     if (selectedType === 'rateio_rzk') {
                         // O input hidden já garante 'RZK'
                     }
                 }
            }

            // Verifica se os elementos existem antes de adicionar listeners
            if (reportTypeSelect && fornecedoraSelect) {
                toggleFornecedora(); // Executa na carga inicial
                reportTypeSelect.addEventListener('change', toggleFornecedora); // Executa ao mudar
            } else {
                if (!reportTypeSelect) console.error("Elemento #report_type não encontrado.");
                if (!fornecedoraSelect) console.error("Elemento #fornecedora não encontrado.");
            }
        });
    </script>
    {# NOSSO NOVO SCRIPT PARA CARREGAR OS DADOS #}
    <script src="{{ url_for('static', filename='js/reports_loader.js') }}"></script>
{% endblock %}