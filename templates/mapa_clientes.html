{# templates/mapa_clientes.html - Refatorado para modularização #}
{% extends "layouts/base_layout.html" %} {# <<< MUDA PARA ESTENDER O NOVO LAYOUT #}

{# Define o título da aba do navegador #}
{% block title %}Mapa de Clientes - Fast BI{% endblock %}

{# Define o título visível no header da página #}
{% block page_title %}Mapa e Gráficos{% endblock %}

{# Conteúdo específico desta página #}
{% block content %}
<div class="container"> {# Container principal da página #}
    <h1>Mapa de Clientes por Estado</h1>
    <p style="text-align: center; margin-bottom: 20px;">Visualização da quantidade de clientes ativos e consumo médio total de kwh por estado</p>

    {# Div onde o mapa Plotly será renderizado #}
    <div id="brazil-map-div" style="width: 100%; max-width: 1000px; height: 650px; margin: 20px auto; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-color: #f9f9f9;">
        <p style="text-align: center; padding-top: 50px; color: #666;">Carregando mapa...</p> {# Mensagem de carregamento inicial #}
    </div>
</div>
{% endblock %} {# Fim do bloco content #}

{# Bloco para scripts JS extras (Plotly) #}
{% block scripts_extra %}
    {# Importa a biblioteca Plotly.js via CDN #}
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapDiv = document.getElementById('brazil-map-div');

            // Busca os dados agregados por estado da nossa API
            fetch("{{ url_for('api_bp.api_state_summary_for_map') }}")
                .then(response => {
                    if (!response.ok) {
                        // Tenta extrair mensagem de erro da API, senão usa status HTTP
                        return response.json().then(err => { throw new Error(err.error || `Erro HTTP: ${response.status}`) });
                    }
                    return response.json(); // Espera um array de objetos: [{'uf': 'SP', 'count': 100, 'sum_consumo': 50000.0}, ...]
                })
                .then(apiData => {
                    // Validação básica da resposta da API
                    if (!Array.isArray(apiData)) {
                         let errorDetail = ""; try { errorDetail = apiData.error || JSON.stringify(apiData); } catch(e) { errorDetail = "Resposta inesperada"; }
                         throw new Error(`Formato de dados inválido recebido da API: ${errorDetail}`);
                    }
                    if (apiData.length === 0) {
                        mapDiv.innerHTML = '<p style="text-align: center; padding-top: 50px; color: #888;">Nenhum dado de estado disponível para exibir no mapa.</p>';
                        console.warn("Nenhum dado recebido da API do mapa.");
                        return; // Interrompe a execução se não houver dados
                    }

                    // Processa os dados da API para o formato do Plotly
                    const locations = []; // Array para as UFs (siglas)
                    const zValues = [];   // Array para o valor que define a COR (será a contagem de clientes)
                    const customData = [];// Array para dados extras exibidos no hover (será a soma do consumo)

                    apiData.forEach(stateData => {
                         // Verifica se o objeto tem as propriedades esperadas e tipos corretos
                         if (stateData && typeof stateData.uf === 'string' && typeof stateData.count === 'number' && typeof stateData.sum_consumo === 'number') {
                            locations.push(stateData.uf);
                            zValues.push(stateData.count);        // Cor baseada na CONTAGEM
                            customData.push(stateData.sum_consumo); // SOMA do consumo para o hover
                        } else {
                            console.warn("Registro de estado inválido ou incompleto recebido da API:", stateData);
                        }
                    });

                    // Verifica se há dados válidos após o processamento
                    if (locations.length === 0) {
                         mapDiv.innerHTML = '<p style="text-align: center; padding-top: 50px; color: #888;">Nenhum dado de estado válido encontrado após processamento.</p>';
                         console.warn("Nenhum dado válido para plotar no mapa após filtrar a resposta da API.");
                         return;
                    }

                    // Define um limite superior (zmax) FIXO para a escala de cores
                    const zmax_cap = 10000; // <<< VALOR FIXO DEFINIDO AQUI >>>
                    console.log(`zmax (contagem clientes) definido com valor fixo: ${zmax_cap}`);

                    // Configuração do trace (a série de dados) para o mapa Plotly
                    const mapTrace = [{
                        type: 'choropleth',         // Tipo de gráfico de mapa
                        locationmode: 'geojson-id', // Modo de localização baseado em ID do GeoJSON
                        geojson: "{{ url_for('static', filename='geojson/brasil-estados.geojson') }}", // Caminho para o arquivo GeoJSON
                        featureidkey: 'properties.sigla', // Chave dentro do GeoJSON que contém a sigla do estado (ex: 'SP')
                        locations: locations,       // Array com as siglas dos estados (UFs)
                        z: zValues,                 // Array com os valores que definem a cor (Contagem de clientes)
                        customdata: customData,     // Array com os dados extras para o hover (Soma do consumo)
                        zmin: 0,                    // Valor mínimo da escala de cores
                        zmax: zmax_cap,             // Valor máximo da escala de cores (calculado acima)
                        colorscale: 'Greens',       // Esquema de cores (Verde)
                        reversescale: true,        // NÃO reverter (verde mais escuro = mais clientes)
                        colorbar: {                 // Configuração da barra de legenda
                            title: 'Qtd. Clientes Ativos', // Título da legenda
                            thickness: 15           // Espessura da barra
                        },
                        hoverinfo: 'location+z+text', // Define o que aparece no hover padrão (antes do template)
                        // Template customizado para o texto do hover
                        hovertemplate: '<b>%{location}</b><br>' + // Sigla do estado em negrito
                                       'Clientes Ativos: %{z:,.0f}<br>' + // Mostra a contagem (de 'z') formatada
                                       'Consumo Total: %{customdata:,.0f} kWh' + // Mostra a soma (de 'customdata') formatada
                                       '<extra></extra>', // Oculta informações extras padrão do Plotly
                        marker: {                   // Configuração das linhas de borda dos estados
                            line: {
                                color: 'rgb(180,180,180)', // Cor da linha
                                width: 0.5                 // Largura da linha
                            }
                        }
                    }];

                    // Configuração do layout do mapa Plotly
                    const mapLayout = {
                        geo:{
                            scope: 'south america',     // Escopo geográfico
                            center: { lon: -54, lat: -15 }, // Centro do mapa
                            projection: { type: 'mercator' }, // Tipo de projeção
                            lataxis: { range: [-35, 6] },   // Limites de latitude
                            lonaxis: { range: [-75, -32] }, // Limites de longitude
                            showland: true,             // Mostrar terra
                            landcolor: 'rgb(230, 230, 230)', // Cor da terra
                            subunitcolor: 'rgb(255, 255, 255)' // Cor das linhas internas (entre estados)
                        },
                        margin: { t: 10, b: 10, l: 10, r: 10 }, // Margens
                        paper_bgcolor: 'rgba(0,0,0,0)', // Fundo do papel transparente
                        plot_bgcolor: 'rgba(0,0,0,0)'   // Fundo da área de plotagem transparente
                    };

                    // Renderiza o gráfico Plotly na div especificada
                    Plotly.newPlot(mapDiv, mapTrace, mapLayout, {
                        responsive: true,   // Torna o gráfico responsivo
                        displaylogo: false // Oculta o logo do Plotly
                    });
                    console.log("Mapa do Brasil (Plotly) renderizado com sucesso.");

                })
                .catch(error => {
                    // Exibe uma mensagem de erro na div do mapa se a API ou o Plotly falharem
                    console.error('Erro ao carregar ou renderizar o mapa:', error);
                    mapDiv.innerHTML = `<p style="color: red; padding: 20px; text-align: center;">Erro ao carregar o mapa: ${error.message}<br>Verifique a URL da API, o caminho do GeoJSON e o console (F12).</p>`;
                });
        });
    </script>
{% endblock %} {# Fim do bloco scripts_extra #}