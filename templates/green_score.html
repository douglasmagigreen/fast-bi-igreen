{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}Green Score por Fornecedora{% endblock %}

{% block head_extra %}
{{ super() }}
{# INÍCIO: Bloco de comentário Jinja2 para a tag <style> #}
{% raw %}
<style>
    /* Estilos existentes para o grid de velocímetros */
    .gauge-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* 280px é o min-width do gauge */
        gap: 30px; /* Espaçamento entre os velocímetros */
        justify-content: center; /* Centraliza o grid horizontalmente */
        align-items: start; /* Alinha os itens no topo do grid */
        padding: 20px;
        background-color: var(--cor-fundo-elemento);
        border-radius: 12px;
        box-shadow: var(--sombra-card);
        border: 1px solid var(--cor-borda-suave);
    }

    /* Estilo para cada card de velocímetro individual, se necessário */
    .gauge-card {
        background-color: var(--cor-fundo-elemento); /* Fundo branco para cada velocímetro */
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Sombra mais leve */
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: transform 0.2s ease;
    }

    .gauge-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* Estilo para o contêiner do ApexCharts dentro do card */
    .gauge-chart-container {
        width: 100%; /* Ocupa a largura total do card */
        min-height: 250px; /* Altura mínima para o gráfico */
        display: flex; /* Para centralizar o gráfico internamente */
        justify-content: center;
        align-items: center;
    }

    /* Mensagem de carregamento/placeholder centralizada no grid */
    .gauge-grid .message-center {
        grid-column: 1 / -1; /* Ocupa todas as colunas */
        text-align: center;
        padding: 50px 20px;
        color: var(--cor-texto-secundario);
    }

    /* Estilos para os novos cards de informação */
    .info-cards-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Dois cards por linha */
        gap: 25px; /* Espaçamento entre os cards */
        margin-top: 25px; /* Espaço acima dos cards de informação */
        margin-bottom: 25px; /* Espaço abaixo dos cards de informação */
    }

    /* Reutiliza estilos de card existentes */
    .info-card {
        background-color: var(--cor-fundo-elemento);
        border-radius: 12px;
        box-shadow: var(--sombra-card);
        border: 1px solid var(--cor-borda-suave);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .info-card .card-header {
        padding: 12px 18px;
        background: linear-gradient(135deg, var(--cor-fundo-header-card), #f3f3f3);
        border-bottom: 1px solid var(--cor-borda-suave);
        font-weight: 500;
        color: var(--cor-texto-secundario);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-card .card-body {
        padding: 20px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .info-card .main-value {
        font-size: 2.6em;
        font-weight: 700;
        color: var(--cor-primaria);
        margin-bottom: 5px;
        line-height: 1.1;
    }

    .info-card .sub-label {
        display: block;
        color: var(--cor-texto-secundario);
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    /* Para os "Clientes do Mês" com dois valores */
    .info-card .qualification-numbers {
        display: flex;
        justify-content: center;
        text-align: center;
        gap: 35px;
        align-items: flex-start;
        width: 100%;
    }
    .info-card .qual-item .qual-number {
        font-size: 2.2em;
        font-weight: 700;
        color: var(--cor-primaria);
        display: block;
        line-height: 1.1;
    }
    .info-card .qual-item .qual-label {
        font-size: 0.85em;
        color: var(--cor-texto-secundario);
        line-height: 1.3;
        margin-top: 3px;
    }

    /* Responsividade para info-cards-container */
    @media (max-width: 768px) {
        .info-cards-container {
            grid-template-columns: 1fr; /* Uma coluna em telas menores */
            gap: 15px;
        }
    }

    /* Novo estilo para o contêiner do logo */
    .supplier-logo-container {
        text-align: center;
        margin-bottom: 20px; /* Espaço entre o logo e os velocímetros/informações */
        min-height: 50px; /* Garante um espaço mínimo */
    }

    .supplier-logo-container img {
        max-height: 80px; /* Altura máxima para o logo */
        max-width: 200px; /* Largura máxima para o logo */
        object-fit: contain; /* Garante que a imagem se ajuste sem distorcer */
        transition: opacity 0.3s ease-in-out; /* Transição para o aparecimento do logo */
    }
</style>
{% endraw %}
{# FIM: Bloco de comentário Jinja2 para a tag <style> #}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <p class="text-center text-muted mb-4">
        Selecione uma fornecedora ou a opção "Consolidado" para visualizar o Green Score de injeção.
    </p>

    <div class="filter-row justify-content-center mb-4">
        <div class="filter-group">
            <label for="fornecedora-filter">Selecione a Fornecedora:</label>
            <select id="fornecedora-filter" class="form-control" style="width: 300px;">
                <option value="">-- Selecione uma Fornecedora --</option>
                <option value="Consolidado">Consolidado (Todas as Fornecedoras)</option>
                {% for forn in fornecedoras %}
                    <option value="{{ forn }}">{{ forn }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {# NOVO: Contêiner para o logo da fornecedora #}
    <div id="supplier-logo-display" class="supplier-logo-container" style="display: none;">
        <img id="supplier-logo-img" src="" alt="Logo da Fornecedora">
    </div>

    {# Contêiner para os cards de informação adicionais #}
    <div id="additional-info-container" class="info-cards-container" style="display: none;">
        {# Card: Resultado do Mês #}
        <div class="info-card kpi-card">
            <div class="card-header">
                Resultado do Mês
                <i class="fas fa-info-circle tooltip-icon" title="Soma do consumo médio dos clientes ativos no mês para esta fornecedora."></i>
            </div>
            <div class="card-body">
                <div class="main-value" id="info-kwh-vendidos">
                    <i class="fas fa-spinner fa-spin fa-sm"></i>
                </div>
                <div class="sub-label">kWh vendidos</div>
            </div>
        </div>

        {# Card: Clientes do Mês (Registrados / Ativados) #}
        <div class="info-card qualification-card">
            <div class="card-header">
                Clientes do Mês
                <i class="fas fa-info-circle tooltip-icon" title="Contagem de clientes registrados e ativados no mês para esta fornecedora."></i>
            </div>
            <div class="card-body">
                <div class="qualification-numbers">
                    <div class="qual-item">
                        <span class="qual-number" id="info-clientes-registrados">
                            <i class="fas fa-spinner fa-spin fa-sm"></i>
                        </span>
                        <span class="qual-label">Registrados<br>no mês</span>
                    </div>
                    <div class="qual-item">
                        <span class="qual-number" id="info-clientes-ativados">
                            <i class="fas fa-spinner fa-spin fa-sm"></i>
                        </span>
                        <span class="qual-label">Ativados<br>no mês</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# O gauge-container será o nosso grid de velocímetros #}
    <div id="gauge-container" class="gauge-grid" style="min-height: 300px;">
        {# Mensagem de placeholder inicial, que será removida/substituída por JS #}
        <div id="placeholder-message" class="message-center">
            <i class="fas fa-hand-pointer fa-2x mb-2"></i>
            <p>Aguardando a seleção de uma fornecedora ou consolidado...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        // Formatação de números para português do Brasil
        function formatNumber(num, decimalPlaces = 0) {
            if (typeof num !== 'number' || isNaN(num)) { return '0'; }
            return num.toLocaleString('pt-BR', {
                minimumFractionDigits: decimalPlaces,
                maximumFractionDigits: decimalPlaces
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/green_score.js') }}"></script>
{% endblock %}