{# templates/dashboard.html - Refatorado para modularização e seleção de cards #}
{% extends "layouts/base_layout.html" %} {# <<< MUDA PARA ESTENDER O NOVO LAYOUT #}

{# Define o título da aba do navegador #}
{% block title %}Painel de Controle - Fast BI{% endblock %}

{# Define o título visível no header da página (incluído via componente header.html) #}
{% block page_title %}Painel de Controle{% endblock %}

{# Conteúdo específico desta página #}
{% block content %}

{# Linha para Filtros e Botão de Seleção #}
<div class="filter-row" style="display: flex; justify-content: space-between; align-items: center;">
    <div class="filter-group">
        <label for="filter-month">FILTRAR POR</label>
        <select id="filter-month" name="month">
            {# Popula as opções passadas pelo Flask #}
            {% for option in month_options %}
                <option value="{{ option.value }}" {% if option.value == selected_month %}selected{% endif %}>
                    {{ option.text }}
                </option>
            {% endfor %}
            {# Fallback se nenhuma opção for passada #}
            {% if not month_options %}
                 <option value="{{ selected_month }}" selected>{{ selected_month }}</option>
            {% endif %}
        </select>
    </div>
    {# <<< NOVO BOTÃO >>> #}
    <button id="select-cards-btn" class="btn btn-primary" style="height: 38px; padding: 0 15px; font-size: 0.85rem;">
        <i class="fas fa-th-large" style="margin-right: 8px;"></i>Selecionar Cards
    </button>
    {# <<< FIM NOVO BOTÃO >>> #}
</div>

{# <<< INÍCIO: Estrutura do Modal de Seleção de Cards >>> #}
<div id="card-selection-modal" class="modal" style="display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">
            <h5 style="margin: 0; font-size: 1.2rem;">Selecionar Cards Visíveis</h5>
            <button id="close-modal-btn" type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #aaa;">&times;</button>
        </div>
        <div class="modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            {# Checkboxes serão adicionados aqui dinamicamente ou manualmente #}
            {# Exemplo manual (o JS pode popular isso de forma mais robusta): #}
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-kpi-resultado-mes"> Resultado do Mês (KPI)</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-kpi-clientes-mes"> Clientes do Mês (KPI)</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-chart-evolucao"> Evolução Ativações</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-table-fornecedora"> Resumo Fornecedora</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-table-concessionaria"> Resumo Concessionária</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-pie-fornecedora"> Pizza Fornecedora</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-bar-concessionaria"> Top 8 Concessionárias</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-table-no-rcb"> Fornecedoras s/ RCB</label></div>
            <div class="checkbox-group"><label><input type="checkbox" name="card-visibility" value="card-chart-vencidos"> Pagamentos Vencidos</label></div>
            {# Adicione um para cada card que deseja controlar #}
        </div>
         <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 20px; text-align: right;">
             <button id="save-card-selection-btn" class="btn btn-success" style="height: 36px; padding: 0 15px; font-size: 0.85rem;">Fechar</button> {# Renomeado para Fechar #}
        </div>
    </div>
</div>
{# <<< FIM: Estrutura do Modal >>> #}


{# Grid para os Widgets/Cards - COM IDs #}
<div class="dashboard-grid"> {# <<< ESTE É O CONTAINER PARA SORTABLEJS >>> #}

    {# Card: Resultado do Mês - DINÂMICO #}
    <div id="card-kpi-resultado-mes" class="card kpi-card"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #}
        <div class="card-header">
            Resultado do Mês
            <i class="fas fa-info-circle tooltip-icon" title="Soma do consumo médio dos clientes com data_ativo no mês selecionado."></i>
        </div>
        <div class="card-body">
            <div class="kpi-main-value" id="kpi-total-kwh">
                 {# Formatação inicial do número vindo do Flask #}
                 {{ "{:,.0f}".format(total_kwh).replace(",", "X").replace(".", ",").replace("X", ".") }}
            </div>
            <div class="kpi-sub-label">kWh vendidos</div>
        </div>
    </div>

    {# Card: Clientes do Mês - COM DOIS VALORES E ORDEM INVERTIDA #}
    <div id="card-kpi-clientes-mes" class="card qualification-card"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #}
        <div class="card-header">Clientes do Mês</div>
        <div class="card-body">
            <div class="qualification-numbers" style="display: flex; justify-content: space-around; align-items: flex-start; gap: 15px;">

                {# Contagem por DTCAD (Agora na Esquerda) #}
                <div class="qual-item" style="text-align: center;">
                    <span class="qual-number" id="kpi-clientes-registrados-count" style="font-size: 2.2em;">
                        {{ "{:,.0f}".format(clientes_registrados_count).replace(",", ".") }}
                    </span>
                    <span class="qual-label" style="font-size: 0.85em;">Registrados<br>no mês</span>
                </div>

                {# Contagem por DATA_ATIVO (Agora na Direita) #}
                <div class="qual-item" style="text-align: center;">
                    <span class="qual-number" id="kpi-clientes-ativos-count" style="font-size: 2.2em;">
                        {{ "{:,.0f}".format(clientes_ativos_count).replace(",", ".") }}
                    </span>
                    <span class="qual-label" style="font-size: 0.85em;">Ativados<br>no mês</span>
                </div>

            </div> {# Fim qualification-numbers #}
        </div>
    </div>

    {# Card: Evolução Mensal - GRÁFICO DINÂMICO #}
    <div id="card-chart-evolucao" class="card chart-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #} {# Ocupa 2 colunas #}
        <div class="card-header">
            <select id="chart-year" name="year">
                 {# Idealmente, popular anos dinamicamente ou ajustar range #}
                 <option value="2025" {% if now().year == 2025 %}selected{% endif %}>2025</option>
                 <option value="2024" {% if now().year == 2024 %}selected{% endif %}>2024</option>
                 <option value="2023" {% if now().year == 2023 %}selected{% endif %}>2023</option>
            </select>
            <span>Evolução Ativações</span> {# Título ajustado #}
        </div>
        <div class="card-body">
            <canvas id="remunerationChart"></canvas> {# ID pode ser renomeado para clareza, ex: monthlyActivationChart #}
        </div>
    </div>

    {# --- LINHA COM AS DUAS TABELAS RESUMO --- #}

    {# Card Resumo por Fornecedora #}
    <div id="card-table-fornecedora" class="card summary-table-card fornecedora-summary-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #}
        <div class="card-header">
            Resumo por Fornecedora (Ativos)
            <i class="fas fa-info-circle tooltip-icon" title="Contagem e consumo dos clientes com data_ativo no mês selecionado. Clique nos cabeçalhos para ordenar."></i>
        </div>
        <div class="card-body">
            <div id="fornecedora-summary-status" style="text-align: center; padding: 10px; display: none;">
                <i class="fas fa-spinner fa-spin fa-sm"></i> Carregando...
            </div>
            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                <table id="fornecedora-summary-table" class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable-header" data-column-index="0" data-sort-type="text">Fornecedora <span class="sort-icon"></span></th>
                            <th scope="col" class="sortable-header" data-column-index="1" data-sort-type="number" style="text-align: right;">Clientes <span class="sort-icon"></span></th>
                            <th scope="col" class="sortable-header" data-column-index="2" data-sort-type="number" style="text-align: right;">Total kWh <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="fornecedora-summary-tbody">
                        <tr><td colspan="3" style="text-align: center; color: #999; font-style: italic;">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# Card Resumo por Concessionária #}
    <div id="card-table-concessionaria" class="card summary-table-card concessionaria-summary-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #}
        <div class="card-header">
            Resumo por Região/Concessionária (Ativos)
            <i class="fas fa-info-circle tooltip-icon" title="Contagem e consumo dos clientes com data_ativo no mês selecionado. Clique nos cabeçalhos para ordenar."></i>
        </div>
        <div class="card-body">
            <div id="concessionaria-summary-status" style="text-align: center; padding: 10px; display: none;">
                <i class="fas fa-spinner fa-spin fa-sm"></i> Carregando...
            </div>
            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                <table id="concessionaria-summary-table" class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable-header" data-column-index="0" data-sort-type="text">
                                Região/Conc. <span class="sort-icon"></span>
                            </th>
                            <th scope="col" class="sortable-header" data-column-index="1" data-sort-type="number" style="text-align: right;">
                                Clientes <span class="sort-icon"></span>
                            </th>
                            <th scope="col" class="sortable-header" data-column-index="2" data-sort-type="number" style="text-align: right;">
                                Total kWh <span class="sort-icon"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="concessionaria-summary-tbody">
                         <tr><td colspan="3" style="text-align: center; color: #999; font-style: italic;">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# --- Card Gráfico Pizza Fornecedora --- #}
    <div id="card-pie-fornecedora" class="card chart-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #} {# Ocupa 2 colunas #}
        <div class="card-header">
            Clientes Ativos por Fornecedora
            <i class="fas fa-info-circle tooltip-icon" title="Distribuição percentual dos clientes com data_ativo no mês selecionado, por fornecedora."></i>
        </div>
        <div class="card-body" style="position: relative; min-height: 300px;">
            <div id="fornecedora-pie-chart-status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; display: none;">
                <i class="fas fa-spinner fa-spin fa-lg"></i><br>Carregando...
            </div>
            <canvas id="fornecedoraPieChart" style="display: block; width: 100%; height: 100%;"></canvas>
        </div>
    </div>

    {# --- Card Gráfico Barras Concessionária (Top 8) --- #}
    <div id="card-bar-concessionaria" class="card chart-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #} {# Ocupa 2 colunas #}
        <div class="card-header">
            Top 8 Regiões/Concessionárias (Clientes Ativos)
            <i class="fas fa-info-circle tooltip-icon" title="Quantidade de clientes com data_ativo no mês selecionado, agrupados por Região/Concessionária (Top 8)."></i>
        </div>
        <div class="card-body" style="position: relative; min-height: 300px;">
            <div id="concessionaria-bar-chart-status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; display: none;">
                <i class="fas fa-spinner fa-spin fa-lg"></i><br>Carregando...
            </div>
            <canvas id="concessionariaBarChart" style="display: block; width: 100%; height: 100%;"></canvas>
        </div>
    </div>

    {# --- CARD: Fornecedoras Cli > 100 dias s/ RCB --- #}
    <div id="card-table-no-rcb" class="card summary-table-card fornecedora-no-rcb-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #}
        <div class="card-header">
            Fornecedoras s/ RCB (Clientes > 100d)
            <i class="fas fa-info-circle tooltip-icon" title="Fornecedoras com clientes ativos há mais de 100 dias e que NÃO possuem nenhum registro na tabela de Recebíveis."></i>
        </div>
        <div class="card-body">
            <div id="fornecedora-no-rcb-status" style="text-align: center; padding: 10px; display: none;">
                <i class="fas fa-spinner fa-spin fa-sm"></i> Carregando...
            </div>
            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                <table id="fornecedora-no-rcb-table" class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable-header" data-column-index="0" data-sort-type="text">Fornecedora <span class="sort-icon"></span></th>
                            <th scope="col" class="sortable-header" data-column-index="1" data-sort-type="number" style="text-align: right;">Clientes <span class="sort-icon"></span></th>
                            <th scope="col" class="sortable-header" data-column-index="2" data-sort-type="number" style="text-align: right;">Total kWh <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="fornecedora-no-rcb-tbody">
                        <tr><td colspan="3" style="text-align: center; color: #999; font-style: italic;">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# --- CARD: Pagamentos Vencidos por Fornecedora --- #}
    <div id="card-chart-vencidos" class="card chart-card grid-span-2"> {# <<< ID ADICIONADO >>> #} {# <<< ITEM ARRASTÁVEL >>> #}
        <div class="card-header">
            <select id="overdue-days-filter" name="days_overdue" style="font-size: 0.9em; border: none; background: transparent; font-weight: bold; color: var(--cor-texto-principal); margin-right: 10px;">
                <option value="30" selected>30 dias</option>
                <option value="60">60 dias</option>
                <option value="90">90 dias</option>
                <option value="120">120 dias</option>
            </select>
            <span>Pagamentos Vencidos s/ Baixa</span>
            <i class="fas fa-info-circle tooltip-icon" title="Contagem de boletos/faturas vencidos (sem data de pagamento registrada) por fornecedora, conforme o período selecionado."></i>
        </div>
        <div class="card-body" style="position: relative; min-height: 300px;">
            <div id="overdue-payments-chart-status" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999; display: none;">
                <i class="fas fa-spinner fa-spin fa-lg"></i><br>Carregando...
            </div>
            <canvas id="overduePaymentsChart" style="display: block; width: 100%; height: 100%;"></canvas>
        </div>
    </div>

</div> {# Fim dashboard-grid #}

{% endblock %} {# Fim do bloco content #}

{# Bloco de Scripts específico para o Dashboard #}
{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{# O script SortableJS já está incluído no base_layout.html via CDN #}

{# <<< INCLUIR O SCRIPT JS UNIFICADO >>> #}
<script src="{{ url_for('static', filename='js/dashboard_controls.js') }}"></script>

{# <<< NENHUM SCRIPT INLINE A MAIS PRECISA ESTAR AQUI >>> #}

{% endblock %} {# Fim do bloco scripts_extra #}