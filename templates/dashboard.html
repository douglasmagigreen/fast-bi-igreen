{# templates/dashboard.html - Final com todos os KPIs e gráfico dinâmicos #}
{% extends "base.html" %}

{# Define o título que pode aparecer na barra superior interna #}
{% block page_title %}Painel de Controle{% endblock %}

{% block content %}

{# Linha para Filtros #}
<div class="filter-row">
    <div class="filter-group">
        <label for="filter-month">FILTRAR POR</label>
        <select id="filter-month" name="month">
            {# Popula as opções passadas pelo Flask #}
            {% for option in month_options %}
                <option value="{{ option.value }}" {% if option.value == selected_month %}selected{% endif %}>
                    {{ option.text }}
                </option>
            {% endfor %}
            {# Fallback se nenhuma opção for passada #}
            {% if not month_options %}
                 <option value="{{ selected_month }}" selected>{{ selected_month }}</option>
            {% endif %}
        </select>
    </div>
</div>

{# Grid para os Widgets/Cards #}
<div class="dashboard-grid">

    {# Card: Resultado do Mês - DINÂMICO #}
    <div class="card kpi-card">
        <div class="card-header">
            Resultado do Mês
            <i class="fas fa-info-circle tooltip-icon" title="Soma do consumo médio dos clientes com data_ativo no mês selecionado."></i>
        </div>
        <div class="card-body">
            <div class="kpi-main-value" id="kpi-total-kwh">
                 {# Formatação inicial do número vindo do Flask #}
                 {{ "{:,.0f}".format(total_kwh).replace(",", "X").replace(".", ",").replace("X", ".") }}
            </div>
            <div class="kpi-sub-label">kWh vendidos</div>
            {# Informações de faturamento removidas anteriormente #}
        </div>
    </div>

    {# Card: Clientes Ativos - DINÂMICO #}
     <div class="card qualification-card">
        <div class="card-header">Clientes Ativos</div>
        <div class="card-body">
            <div class="qualification-numbers">
                <div class="qual-item">
                    {# Adiciona ID ao número principal e usa valor do Flask #}
                    <span class="qual-number" id="kpi-clientes-ativos-count">
                        {{ "{:,.0f}".format(clientes_ativos_count).replace(",", ".") }} {# Formatação inicial #}
                    </span>
                    <span class="qual-label">Clientes<br>ativados no mês</span> {# Label ajustado #}
                </div>
                {# Segunda parte e link removidos anteriormente #}
            </div>
        </div>
     </div>

    {# Card: Evolução Mensal - GRÁFICO DINÂMICO #}
    <div class="card chart-card">
        <div class="card-header">
            <select id="chart-year" name="year">
                 {# Idealmente, popular anos dinamicamente #}
                 <option value="2025" selected>2025</option>
                 <option value="2024">2024</option>
                 <option value="2023">2023</option>
            </select>
            <span>Evolução Mensal</span>
        </div>
        <div class="card-body">
            <canvas id="remunerationChart"></canvas> {# ID pode ser renomeado para clareza, ex: monthlyActiveClientsChart #}
        </div>
    </div>

    {# Card Resumo por Fornecedora - DINÂMICO #}
    <div class="card fornecedora-summary-card grid-span-2"> {# Classe para ocupar 2 colunas #}
        <div class="card-header">
            Resumo por Fornecedora (Clientes Ativos)
            <i class="fas fa-info-circle tooltip-icon" title="Contagem e consumo dos clientes com data_ativo no mês selecionado."></i>
        </div>
        <div class="card-body">
            {# Placeholder para Loading/Erro #}
            <div id="fornecedora-summary-status" style="text-align: center; padding: 20px; display: none;">
                <i class="fas fa-spinner fa-spin"></i> Carregando...
            </div>
            {# Tabela com tbody identificado #}
            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                <table class="table table-sm table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Fornecedora</th>
                            <th style="text-align: right;">Clientes Ativos</th> {# Cabeçalho alterado #}
                            <th style="text-align: right;">Total de kWh</th>     {# Cabeçalho alterado #}
                        </tr>
                    </thead>
                    {# O CORPO DA TABELA SERÁ PREENCHIDO PELO JAVASCRIPT #}
                    <tbody id="fornecedora-summary-tbody">
                        {# Dados iniciais carregados pelo Flask (se houver) #}
                         {% if fornecedora_summary %}
                            {% for row in fornecedora_summary %}
                            <tr>
                                <td>{{ row[0] }}</td>
                                <td style="text-align: right;">{{ row[1] | int }}</td>
                                {# Formatação inicial com sufixo kWh #}
                                <td style="text-align: right;">{{ "{:,.2f}".format(row[2]).replace(",", "X").replace(".", ",").replace("X", ".") }} kWh</td>
                            </tr>
                            {% endfor %}
                        {% elif not error_summary %} {# Se não for erro, mas vazio #}
                            <tr><td colspan="3" style="text-align: center;">Nenhum dado encontrado para o mês selecionado.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {# Exibe erro inicial do Flask aqui se houver #}
            {% if error_summary %}
                 <p class="text-danger" style="text-align: center; margin-top: 10px;">{{ error_summary }}</p>
            {% endif %}
        </div>
    </div>

</div> {# Fim dashboard-grid #}

{% endblock %}

{# Bloco de Scripts com a nova lógica AJAX para TODOS os cards e GRÁFICO dinâmicos #}
{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- Variável para guardar a instância do gráfico ---
    let monthlyChartInstance = null; // Renomeado para clareza

    // --- Elementos do DOM ---
    const monthSelect = document.getElementById('filter-month');
    const summaryTableBody = document.getElementById('fornecedora-summary-tbody');
    const summaryStatus = document.getElementById('fornecedora-summary-status');
    const kpiTotalKwhElement = document.getElementById('kpi-total-kwh');
    const kpiClientesAtivosElement = document.getElementById('kpi-clientes-ativos-count');
    const chartCanvas = document.getElementById('remunerationChart'); // Ou novo ID
    const yearSelectChart = document.getElementById('chart-year');

    // --- Função para formatar número ---
    function formatNumber(num, decimalPlaces = 0) {
        if (typeof num !== 'number' || isNaN(num)) return '0'; // Retorna '0' se inválido
        return num.toLocaleString('pt-BR', {
            minimumFractionDigits: decimalPlaces,
            maximumFractionDigits: decimalPlaces
        });
    }

    // --- Função para Atualizar Gráfico Mensal ---
    async function updateChartData(year) {
        if (!monthlyChartInstance) {
            console.error("Instância do Chart não encontrada para atualizar.");
            return;
        }
        console.log(`Atualizando gráfico para o ano: ${year}`);
        // Pode adicionar um estado visual de "carregando" aqui se desejar

        try {
            const apiUrl = "{{ url_for('api_chart_monthly_active_clients') }}";
            const response = await fetch(`${apiUrl}?year=${year}`);
            if (!response.ok) {
                let errorMsg = `Erro ${response.status}`; try { const d = await response.json(); errorMsg = d.error || errorMsg; } catch(e){} throw new Error(errorMsg);
            }
            const chartData = await response.json();

            if (chartData && chartData.monthly_counts) {
                monthlyChartInstance.data.datasets[0].data = chartData.monthly_counts;
                monthlyChartInstance.data.datasets[0].label = 'Clientes Ativados';
                monthlyChartInstance.update();
                console.log("Dados do gráfico atualizados:", chartData.monthly_counts);
            } else {
                 console.warn("Nenhum dado recebido para o gráfico do ano:", year);
                 monthlyChartInstance.data.datasets[0].data = Array(12).fill(0); // Zera os dados
                 monthlyChartInstance.data.datasets[0].label = 'Sem dados';
                 monthlyChartInstance.update();
            }
        } catch (error) {
            console.error(`Erro ao buscar dados do gráfico para ${year}:`, error);
            // Pode mostrar uma mensagem de erro no lugar do gráfico
        } finally {
            // Remover estado visual de "carregando"
        }
    }

    // --- Inicialização do Gráfico ---
    if (chartCanvas && yearSelectChart) {
        const initialYear = yearSelectChart.value;
        const labels = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
        const initialData = {
            labels: labels,
            datasets: [{ label: 'Carregando...', data: Array(12).fill(0), fill: false, borderColor: 'rgb(75, 192, 192)', tension: 0.4 }]
        };
        const config = { type: 'line', data: initialData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } };
        monthlyChartInstance = new Chart(chartCanvas, config); // Guarda a instância
        console.log("Gráfico inicializado.");
        updateChartData(initialYear); // Busca dados iniciais

        // --- Listener para mudança de ano no GRÁFICO ---
        yearSelectChart.addEventListener('change', function() {
            updateChartData(this.value);
        });
    } else {
        if(!chartCanvas) console.error("Elemento canvas do gráfico não encontrado.");
        if(!yearSelectChart) console.error("Elemento select #chart-year não encontrado.");
    }


    // --- Função GERAL para buscar dados dos KPIs e Resumo ---
    async function updateDashboardData(month) {
        // Indicadores de carregamento
        if(summaryStatus) { summaryStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando resumo...'; summaryStatus.style.display = 'block'; }
        if(summaryTableBody) summaryTableBody.innerHTML = '';
        if(kpiTotalKwhElement) kpiTotalKwhElement.innerHTML = '<i class="fas fa-spinner fa-spin fa-xs"></i>';
        if(kpiClientesAtivosElement) kpiClientesAtivosElement.innerHTML = '<i class="fas fa-spinner fa-spin fa-xs"></i>';

        // Cria Promises para todas as chamadas API
        const fetchSummary = fetch("{{ url_for('api_fornecedora_summary') }}?month=" + month);
        const fetchKpiKwh = fetch("{{ url_for('api_kpi_total_kwh') }}?month=" + month);
        const fetchKpiClientes = fetch("{{ url_for('api_kpi_clientes_ativos') }}?month=" + month);

        // Processa todas as Promises
        try {
            const [summaryResponse, kpiKwhResponse, kpiClientesResponse] = await Promise.all([fetchSummary, fetchKpiKwh, fetchKpiClientes]);

            // Processa Resumo Fornecedora
            if (summaryTableBody && summaryStatus) {
                 if (!summaryResponse.ok) { let errorMsg = `Erro ${summaryResponse.status}`; try { const d = await summaryResponse.json(); errorMsg = d.error || errorMsg; } catch(e){} throw new Error(errorMsg); }
                 const dataSummary = await summaryResponse.json();
                 summaryStatus.style.display = 'none';
                 if (dataSummary && dataSummary.length > 0) { dataSummary.forEach(row => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${row.fornecedora}</td><td style="text-align: right;">${formatNumber(row.qtd_clientes, 0)}</td><td style="text-align: right;">${formatNumber(row.soma_consumo, 2)} kWh</td>`; summaryTableBody.appendChild(tr); }); }
                 else { summaryTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Nenhum dado encontrado para este mês.</td></tr>'; }
            }

            // Processa KPI Total kWh
            if (kpiTotalKwhElement) {
                if (!kpiKwhResponse.ok) { let errorMsg = `Erro ${kpiKwhResponse.status}`; try { const d = await kpiKwhResponse.json(); errorMsg = d.error || errorMsg; } catch(e){} throw new Error(errorMsg); }
                const dataKpi = await kpiKwhResponse.json();
                kpiTotalKwhElement.textContent = formatNumber(dataKpi.total_kwh, 0);
            }

             // Processa KPI Clientes Ativos
             if (kpiClientesAtivosElement) {
                 if (!kpiClientesResponse.ok) { let errorMsg = `Erro ${kpiClientesResponse.status}`; try { const d = await kpiClientesResponse.json(); errorMsg = d.error || errorMsg; } catch(e){} throw new Error(errorMsg); }
                 const dataClientes = await kpiClientesResponse.json();
                 kpiClientesAtivosElement.textContent = formatNumber(dataClientes.clientes_ativos_count, 0);
             }

        } catch (error) {
            console.error('Erro ao buscar dados do dashboard:', error);
            // Trata erros gerais - pode exibir uma mensagem de erro mais genérica
            if(summaryStatus) { summaryStatus.innerHTML = `<span style="color: red;"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar dados: ${error.message}</span>`; summaryStatus.style.display = 'block'; }
            if(kpiTotalKwhElement) kpiTotalKwhElement.innerHTML = `<span style="font-size: 0.5em; color: red;">Erro!</span>`;
            if(kpiClientesAtivosElement) kpiClientesAtivosElement.innerHTML = `<span style="font-size: 0.5em; color: red;">Erro!</span>`;
        }
    }

    // --- Listener para o filtro de MÊS ---
    if (monthSelect) {
        monthSelect.addEventListener('change', function() {
            const selectedMonth = this.value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('month', selectedMonth);
            window.history.replaceState({}, '', currentUrl);
            updateDashboardData(selectedMonth); // Chama a função geral
        });
    } else {
        console.error("Elemento #filter-month não encontrado.");
    }
    // --- FIM Script Atualização Dashboard ---

    // --- Script para Copiar Link (se existir) ---
    // ... (código existente) ...
});
</script>
{% endblock %}