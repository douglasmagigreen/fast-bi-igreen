{# templates/dashboard.html - REFATORADO COM CLASSES TAILWIND CSS #}
{% extends "base.html" %} {# Assume que base.html também foi refatorado para Tailwind #}

{% block page_title %}Painel de Controle{% endblock %}

{% block content %}

{# Linha para Filtros - Usando Flexbox e espaçamento Tailwind #}
<div class="mb-6 flex items-center space-x-4"> {# mb-6: Margem inferior, flex/items-center: Alinhamento, space-x-4: Espaço entre itens #}
    <label for="filter-month" class="text-sm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">FILTRAR POR</label>
    {# select com estilo Tailwind: rounded, border, padding, focus styles #}
    <select id="filter-month" name="month" class="block w-auto rounded-md border-gray-300 shadow-sm focus:border-igreen focus:ring focus:ring-igreen-light focus:ring-opacity-50 text-sm py-2 px-3">
        {% for option in month_options %}
            <option value="{{ option.value }}" {% if option.value == selected_month %}selected{% endif %}>
                {{ option.text }}
            </option>
        {% endfor %}
        {% if not month_options %}
             <option value="{{ selected_month }}" selected>{{ selected_month }}</option>
        {% endif %}
    </select>
</div>

{# Grid para os Widgets/Cards - Responsivo #}
{# grid: Habilita grid, gap-6: Espaçamento entre cards, grid-cols-1/md:grid-cols-2/xl:grid-cols-4: Define colunas responsivas #}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">

    {# Card: Resultado do Mês - Estilo Tailwind #}
    {# bg-white: Fundo, rounded-lg: Cantos, shadow: Sombra, overflow-hidden: Necessário p/ cantos, flex/flex-col: Layout coluna #}
    <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col">
        {# Header do Card: Padding, Fundo, Borda, Estilo de texto #}
        <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider flex justify-between items-center">
            <span>Resultado do Mês</span>
            <i class="fas fa-info-circle text-gray-400 cursor-help" title="Soma do consumo médio dos clientes com data_ativo no mês selecionado."></i>
        </div>
        {# Corpo do Card: Padding, Centralização com Flexbox #}
        <div class="p-5 flex-grow flex flex-col items-center justify-center">
            {# Valor Principal: Tamanho, Peso, Cor (usando cor customizada 'igreen-dark' ou padrão 'green-700') #}
            <div class="text-4xl font-bold text-igreen-dark mb-1" id="kpi-total-kwh">
                 {{ "{:,.0f}".format(total_kwh).replace(",", "X").replace(".", ",").replace("X", ".") }}
            </div>
            {# Label Secundário: Tamanho, Cor #}
            <div class="text-sm text-gray-500">kWh vendidos</div>
        </div>
    </div>

    {# Card: Clientes do Mês - Estilo Tailwind #}
    <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col">
        <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes do Mês</div>
        {# Corpo do Card: Centralização, Espaçamento entre itens #}
        <div class="p-5 flex-grow flex items-center justify-center space-x-8 text-center">
            {# Item 1: Clientes Registrados #}
            <div>
                <span class="block text-3xl font-bold text-igreen-dark" id="kpi-clientes-registrados-count">
                    {{ "{:,.0f}".format(clientes_registrados_count).replace(",", ".") }}
                </span>
                <span class="block text-xs text-gray-500 mt-1 leading-tight">Registrados<br>no mês</span>
            </div>
             {# Item 2: Clientes Ativados #}
            <div>
                 <span class="block text-3xl font-bold text-igreen-dark" id="kpi-clientes-ativos-count">
                    {{ "{:,.0f}".format(clientes_ativos_count).replace(",", ".") }}
                 </span>
                <span class="block text-xs text-gray-500 mt-1 leading-tight">Ativados<br>no mês</span>
            </div>
        </div>
    </div>

    {# Card: Evolução Mensal (Gráfico) - Ocupa 2 colunas em telas maiores #}
    {# col-span-1/md:col-span-2/xl:col-span-2: Define quantas colunas o card ocupa responsivamente #}
    <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col col-span-1 md:col-span-2 xl:col-span-2">
        <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider flex justify-between items-center">
             {# Select com estilo similar ao filtro principal #}
            <select id="chart-year" name="year" class="text-xs font-semibold border-none bg-transparent focus:ring-0 p-0 pr-6">
                 <option value="2025" {% if now().year == 2025 %}selected{% endif %}>2025</option>
                 <option value="2024" {% if now().year == 2024 %}selected{% endif %}>2024</option>
                 <option value="2023" {% if now().year == 2023 %}selected{% endif %}>2023</option>
            </select>
            <span>Evolução Ativações</span>
        </div>
        {# Corpo do Card: Padding, Altura mínima, Posição relativa para o canvas #}
        <div class="p-4 flex-grow min-h-[280px] relative">
            {# O Canvas em si não precisa de muitas classes Tailwind, o JS cuida do resto #}
            <canvas id="remunerationChart"></canvas>
        </div>
    </div>

    {# --- LINHA INFERIOR COM AS DUAS TABELAS --- #}
    {# Ambas tabelas ocupam 2 colunas em telas maiores #}

    {# Card Resumo por Fornecedora - Estilo Tailwind #}
    <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col col-span-1 md:col-span-2 xl:col-span-2">
        <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider flex justify-between items-center">
            <span>Resumo por Fornecedora (Ativos)</span>
            <i class="fas fa-info-circle text-gray-400 cursor-help" title="Contagem e consumo dos clientes com data_ativo no mês selecionado. Clique nos cabeçalhos para ordenar."></i>
        </div>
        {# Corpo do Card: Flex-grow permite que a tabela ocupe espaço #}
        <div class="flex-grow flex flex-col">
            {# Status de Carregamento/Erro #}
            <div id="fornecedora-summary-status" class="p-3 text-center text-sm text-gray-500 italic" style="display: none;">
                <i class="fas fa-spinner fa-spin fa-sm mr-2"></i> Carregando...
            </div>
            {# Container da Tabela com scroll vertical e altura máxima #}
            <div class="overflow-y-auto max-h-[250px] flex-grow">
                {# Tabela com estilo Tailwind #}
                <table id="fornecedora-summary-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10"> {# Sticky header #}
                        <tr>
                            {# Cabeçalho: Padding, Estilo Texto, Alinhamento, Cursor para ordenação #}
                            <th scope="col" class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider sortable-header" data-column-index="0" data-sort-type="text">
                                Fornecedora <span class="sort-icon ml-1"></span>
                            </th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider sortable-header" data-column-index="1" data-sort-type="number">
                                Clientes <span class="sort-icon ml-1"></span>
                            </th>
                             <th scope="col" class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider sortable-header" data-column-index="2" data-sort-type="number">
                                Total kWh <span class="sort-icon ml-1"></span>
                            </th>
                        </tr>
                    </thead>
                    {# Corpo da Tabela: Estilo zebrado (even:bg-gray-50), hover (hover:bg-gray-100) #}
                    <tbody id="fornecedora-summary-tbody" class="bg-white divide-y divide-gray-200 text-sm">
                        {# Placeholder inicial #}
                        <tr><td colspan="3" class="px-4 py-4 text-center text-gray-400 italic">Carregando dados...</td></tr>
                        {# Dados preenchidos via AJAX aqui #}
                    </tbody>
                </table>
            </div>
             {# Exibe erro inicial do Flask (se houver) #}
            {% if error_summary %}
                 <p class="px-4 py-2 text-center text-xs text-red-600">{{ error_summary }}</p>
            {% endif %}
        </div>
    </div>

    {# Card Resumo por Concessionária - Estilo Tailwind (similar ao anterior) #}
    <div class="bg-white rounded-lg shadow overflow-hidden flex flex-col col-span-1 md:col-span-2 xl:col-span-2">
        <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider flex justify-between items-center">
            <span>Resumo por Região/Conc. (Ativos)</span>
            <i class="fas fa-info-circle text-gray-400 cursor-help" title="Contagem e consumo dos clientes com data_ativo no mês selecionado. Clique nos cabeçalhos para ordenar."></i>
        </div>
        <div class="flex-grow flex flex-col">
            <div id="concessionaria-summary-status" class="p-3 text-center text-sm text-gray-500 italic" style="display: none;">
                <i class="fas fa-spinner fa-spin fa-sm mr-2"></i> Carregando...
            </div>
            <div class="overflow-y-auto max-h-[250px] flex-grow">
                <table id="concessionaria-summary-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider sortable-header" data-column-index="0" data-sort-type="text">
                                Região/Conc. <span class="sort-icon ml-1"></span>
                            </th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider sortable-header" data-column-index="1" data-sort-type="number">
                                Clientes <span class="sort-icon ml-1"></span>
                            </th>
                             <th scope="col" class="px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider sortable-header" data-column-index="2" data-sort-type="number">
                                Total kWh <span class="sort-icon ml-1"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="concessionaria-summary-tbody" class="bg-white divide-y divide-gray-200 text-sm">
                         <tr><td colspan="3" class="px-4 py-4 text-center text-gray-400 italic">Carregando dados...</td></tr>
                         {# Dados preenchidos via AJAX aqui #}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div> {# Fim dashboard-grid #}

{% endblock %}

{# Bloco de Scripts com AJAX e Ordenação (manter como estava) #}
{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- Variável para guardar a instância do gráfico ---
    let monthlyChartInstance = null;

    // --- Elementos do DOM ---
    const monthSelect = document.getElementById('filter-month');
    const fornecedoraTableBody = document.getElementById('fornecedora-summary-tbody');
    const fornecedoraStatus = document.getElementById('fornecedora-summary-status');
    const concessionariaTableBody = document.getElementById('concessionaria-summary-tbody');
    const concessionariaStatus = document.getElementById('concessionaria-summary-status');
    const kpiTotalKwhElement = document.getElementById('kpi-total-kwh');
    const kpiClientesAtivosElement = document.getElementById('kpi-clientes-ativos-count');
    const kpiClientesRegistradosElement = document.getElementById('kpi-clientes-registrados-count');
    const chartCanvas = document.getElementById('remunerationChart');
    const yearSelectChart = document.getElementById('chart-year');

    // --- Função para formatar número (manter) ---
    function formatNumber(num, decimalPlaces = 0) { /* ...código formatNumber ... */ }

    // --- Função para Atualizar Gráfico Mensal (manter) ---
    async function updateChartData(year) { /* ...código updateChartData ... */ }

    // --- Inicialização do Gráfico (manter, talvez ajustar cores no JS se não fez no config) ---
    if (chartCanvas && yearSelectChart) {
         // ... (código de inicialização do Chart.js) ...
         // Exemplo: Pode ajustar cores aqui se não fez no config do Tailwind
         // backgroundColor: 'rgba(0, 176, 52, 0.1)', // bg-igreen-light com opacidade
         // borderColor: 'rgb(0, 176, 52)', // text-igreen
         // pointBackgroundColor: 'rgb(0, 176, 52)',
         // ... (restante do código de inicialização) ...
         // updateChartData(initialYear);
         // yearSelectChart.addEventListener('change', function() { updateChartData(this.value); });
    } else { /* ... logs de erro ... */ }


    // --- Função GERAL para buscar dados (KPIs e Resumos) (manter) ---
    async function updateDashboardData(month) {
         // ... (código AJAX para buscar dados e preencher KPIs/Tabelas) ...
         // IMPORTANTE: O código que preenche as tabelas (ex: `fornecedoraTableBody.innerHTML = ''; ... tr.innerHTML = ...`)
         // PRECISA ser atualizado para gerar TRs e TDs com as classes Tailwind corretas!

         // Exemplo de atualização do innerHTML para tabela fornecedora:
         if (fornecedoraTableBody && fornecedoraStatus) {
             fornecedoraStatus.style.display = 'none';
             fornecedoraTableBody.innerHTML = '';
             if (dataSummaryForn && dataSummaryForn.length > 0) {
                dataSummaryForn.forEach(row => {
                    const tr = document.createElement('tr');
                    // Adiciona classes Tailwind ao TR (zebrado/hover é feito pelo CSS no tbody)
                    tr.classList.add('hover:bg-gray-50'); // Adiciona classe de hover dinamicamente
                    if (fornecedoraTableBody.children.length % 2 !== 0) {
                         tr.classList.add('bg-gray-50'); // Aplica zebrado dinamicamente
                    }
                    // Adiciona classes Tailwind aos TDs
                    tr.innerHTML = `<td class="px-4 py-3 whitespace-nowrap text-gray-700">${row.fornecedora || 'N/A'}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right font-mono text-gray-700">${formatNumber(row.qtd_clientes, 0)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right font-mono text-gray-700">${formatNumber(row.soma_consumo, 2)} kWh</td>`;
                    fornecedoraTableBody.appendChild(tr);
                 });
                 reapplySort('fornecedora-summary-table');
             } else {
                 fornecedoraTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400 italic">Nenhum dado de fornecedora.</td></tr>';
             }
         }
         // FAZER O MESMO para a tabela de concessionária!!

         // ... (restante do código AJAX) ...
    }

    // --- Listener para o filtro de MÊS (manter) ---
    if (monthSelect) { /* ... código listener monthSelect ... */ }

    // --- FUNÇÃO GENÉRICA PARA ORDENAÇÃO DE TABELA (manter) ---
    const sortState = {};
    function getCellValue(row, columnIndex, sortType) { /* ... código getCellValue ... */ }
    function updateSortIcons(tableId, clickedHeader) { /* ... código updateSortIcons ... */ }
    function sortTable(tableId, columnIndex, sortType) { /* ... código sortTable ... */ }
    function reapplySort(tableId) { /* ... código reapplySort ... */ }

    // --- Adiciona Listeners de clique para os cabeçalhos (manter) ---
    function addSortListeners(tableId, headerSelectorClass) { /* ... código addSortListeners ... */ }

    // Adiciona listeners usando a classe 'sortable-header'
    addSortListeners('fornecedora-summary-table', 'sortable-header');
    addSortListeners('concessionaria-summary-table', 'sortable-header');

    // Chamar a atualização inicial dos dados via AJAX
     if (monthSelect) { updateDashboardData(monthSelect.value); }

}); // Fim DOMContentLoaded
</script>
{% endblock %}