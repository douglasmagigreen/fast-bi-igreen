{# templates/dashboard.html - MODIFICADO com card Resumo Fornecedora #}
{% extends "base.html" %}

{# Define o título que pode aparecer na barra superior interna #}
{% block page_title %}Painel de Controle{% endblock %}

{% block content %}

{# Linha para Filtros #}
<div class="filter-row">
    <div class="filter-group">
        <label for="filter-month">FILTRAR POR</label>
        <select id="filter-month" name="month">
            <option value="2025-04" selected>ABR/2025</option> {# Exemplo Estático #}
            <option value="2025-03">MAR/2025</option>
            {# Adicionar mais opções dinamicamente se necessário #}
        </select>
    </div>
    {# Outros filtros podem ir aqui #}
</div>

{# Grid para os Widgets/Cards - Usaremos CSS Grid ou Flexbox #}
<div class="dashboard-grid">

    {# Card: Resultado do Mês #}
    <div class="card kpi-card">
        <div class="card-header">
            Resultado do Mês
            <i class="fas fa-info-circle tooltip-icon" title="Dados consolidados do mês selecionado."></i> {# Ícone Info #}
        </div>
        <div class="card-body">
            <div class="kpi-main-value">269.656</div>
            <div class="kpi-sub-label">kWh vendidos</div>
            <hr class="kpi-divider">
            <div class="kpi-secondary-values">
                <div>
                    <span class="kpi-secondary-label">Faturamento total (R$) ABR/2025</span>
                    <span class="kpi-secondary-value">R$ 37.260,73</span>
                     <i class="fas fa-info-circle tooltip-icon" title="Faturamento bruto do período."></i>
                </div>
                <div>
                    <span class="kpi-secondary-label">Faturamento consolidado (R$)</span>
                    <span class="kpi-secondary-value">R$ 105.571,98</span>
                     <i class="fas fa-info-circle tooltip-icon" title="Faturamento acumulado."></i>
                </div>
            </div>
        </div>
    </div>

    {# Card: Clientes Ativos #}
     <div class="card qualification-card">
        <div class="card-header">Clientes Ativos</div>
        <div class="card-body">
            <div class="qualification-numbers">
                <div class="qual-item">
                    <span class="qual-number">974</span>
                    <span class="qual-label">Endereços<br>ativos</span>
                </div>
                <div class="qual-item">
                    <span class="qual-number">268</span>
                    <span class="qual-label">Endereços<br>pendentes/<br>desativados</span>
                </div>
            </div>
             <a href="#" class="details-link">VER DETALHES</a>
        </div>
    </div>

    {# Card: Evolução da Remuneração (Gráfico) #}
    <div class="card chart-card">
        <div class="card-header">
            <select id="chart-year" name="year">
                 <option value="2025" selected>2025</option>
                 <option value="2024">2024</option>
            </select>
            <span>Evolução Mensal</span>
        </div>
        <div class="card-body">
            {# Área onde o gráfico será renderizado (ex: com Chart.js) #}
            <canvas id="remunerationChart"></canvas>
        </div>
    </div>

</div> {# Fim dashboard-grid #}

{# <<< INÍCIO DO NOVO CARD: Resumo por Fornecedora >>> #}
<div class="card fornecedora-summary-card"> {# Adicionada classe específica se precisar de estilo futuro #}
    <div class="card-header">
        Resumo por Fornecedora (Clientes Ativos)
        <i class="fas fa-info-circle tooltip-icon" title="Contagem de clientes ativos e soma do consumo médio agrupados por fornecedora."></i>
    </div>
    <div class="card-body">
        {# Verifica se a variável passada pelo app.py (fornecedora_summary) existe e tem dados #}
        {% if fornecedora_summary is not none and fornecedora_summary %}
            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;"> {# Adiciona scroll se a tabela for grande #}
                <table class="table table-sm table-striped table-hover"> {# Estilos básicos de tabela (Bootstrap-like) #}
                    <thead>
                        <tr>
                            <th>Fornecedora</th>
                            <th style="text-align: right;">Qtd Clientes</th>
                            <th style="text-align: right;">Soma Consumo Médio</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Loop para exibir cada linha de dados vinda do backend #}
                        {% for row in fornecedora_summary %}
                        <tr>
                            <td>{{ row[0] }}</td> {# Coluna 0: fornecedora_tratada #}
                            <td style="text-align: right;">{{ row[1] | int }}</td> {# Coluna 1: qtd_clientes #}
                             {# Coluna 2: soma_consumo_medio - Formata para padrão BR #}
                            <td style="text-align: right;">{{ "{:,.2f}".format(row[2]).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elif fornecedora_summary is none %} {# Se for None, indica erro no backend #}
             <p class="text-danger">Erro ao carregar dados das fornecedoras.</p>
        {% else %} {# Se a lista estiver vazia, mas não for None #}
            <p>Nenhum dado de fornecedora encontrado para exibir.</p>
        {% endif %}
    </div>
</div>
{# <<< FIM DO NOVO CARD >>> #}

{% endblock %}

{% block scripts_extra %}
{# Incluir Chart.js (se for usar) #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Exemplo de Script para o Gráfico ---
    const ctx = document.getElementById('remunerationChart');
    if (ctx) {
        // Dados de exemplo - Substituir por dados reais (via AJAX ou Jinja)
        const labels = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
        const data = {
            labels: labels,
            datasets: [{
                label: 'Remuneração',
                data: [0, 10, 40, 80, 30, 15, 5, 0, 0, 0, 0, 0], // Dados exemplo da imagem
                fill: false,
                borderColor: 'rgb(75, 192, 192)', // Cor da linha (verde/azul)
                tension: 0.4 // Suaviza a curva
            }]
        };
        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }, // Esconde legenda
                scales: {
                     y: { beginAtZero: true, ticks: { display: false } , grid: { display: false} }, // Esconde eixo Y
                     x: { grid: { display: false } } // Esconde grid X
                 }
            }
        };
        new Chart(ctx, config);
    }

    // --- Script para Copiar Link (Exemplo) ---
    const copyButton = document.querySelector('.btn-copy-link');
    const linkInput = document.querySelector('.indication-link-area input');
    if (copyButton && linkInput) {
        copyButton.addEventListener('click', function() {
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Para mobile
            try {
                document.execCommand('copy');
                // (Opcional) Mudar texto do botão ou mostrar notificação
                console.log('Link copiado!');
                 alert('Link copiado para a área de transferência!');
            } catch (err) {
                console.error('Falha ao copiar link: ', err);
                alert('Não foi possível copiar o link.');
            }
            window.getSelection().removeAllRanges(); // Desseleciona
        });
    }
});
</script>
{% endblock %}